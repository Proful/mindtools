<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Multiplayer Quiz Application</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #333;
        line-height: 1.6;
        min-height: 100vh;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
        background-color: #fff;
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .connection-status {
        background-color: #f5f5f5;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
      }

      .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 500;
      }

      .status-connected {
        background-color: #e8f5e9;
        color: #2e7d32;
      }

      .status-waiting {
        background-color: #fff3e0;
        color: #e65100;
      }

      .status-room-id {
        background-color: #e3f2fd;
        color: #1565c0;
        font-family: monospace;
      }

      .progress-bar {
        height: 8px;
        background-color: #e0e0e0;
        border-radius: 4px;
        margin-bottom: 20px;
        overflow: hidden;
      }

      .progress {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        transition: width 0.3s ease;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 10px;
      }

      .scores {
        display: flex;
        gap: 20px;
      }

      .score-item {
        text-align: center;
      }

      .score-item .label {
        font-size: 0.9rem;
        color: #666;
      }

      .score-item .value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #667eea;
      }

      .quiz-container {
        flex-grow: 1;
      }

      .question {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 20px;
        line-height: 1.4;
        color: #222;
      }

      .options {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 30px;
      }

      .option {
        position: relative;
        background-color: #f9f9f9;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .option:hover {
        background-color: #f1f1f1;
        border-color: #ccc;
        transform: translateX(5px);
      }

      .option.selected {
        background-color: #e8f5e9;
        border-color: #667eea;
      }

      .option.correct {
        background-color: #e8f5e9;
        border-color: #4caf50;
      }

      .option.incorrect {
        background-color: #ffebee;
        border-color: #f44336;
      }

      .option.other-user-selected {
        border-color: #ff9800;
        background-color: #fff3e0;
      }

      .option input {
        position: absolute;
        opacity: 0;
        cursor: pointer;
      }

      .option label {
        display: flex;
        align-items: center;
        cursor: pointer;
        width: 100%;
      }

      .option span.radio {
        height: 20px;
        width: 20px;
        min-width: 20px;
        background-color: #fff;
        border: 2px solid #ccc;
        border-radius: 50%;
        margin-right: 12px;
        position: relative;
      }

      .option input:checked ~ label span.radio {
        border-color: #667eea;
      }

      .option input:checked ~ label span.radio:after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: #667eea;
      }

      .option span.mark {
        margin-left: auto;
        font-size: 1.2rem;
        display: none;
      }

      .option.correct span.mark {
        display: block;
        color: #4caf50;
      }

      .option.incorrect span.mark {
        display: block;
        color: #f44336;
      }

      .option-indicator {
        margin-left: auto;
        font-size: 0.85rem;
        padding: 4px 8px;
        border-radius: 4px;
        display: none;
      }

      .option.other-user-selected .option-indicator {
        display: block;
        background-color: #ff9800;
        color: white;
      }

      .actions {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        margin-top: 20px;
        flex-wrap: wrap;
      }

      button {
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-prev {
        background-color: #e0e0e0;
        color: #333;
      }

      .btn-prev:hover:not(:disabled) {
        background-color: #d0d0d0;
      }

      .btn-next {
        background-color: #667eea;
        color: white;
      }

      .btn-next:hover:not(:disabled) {
        background-color: #5568d3;
      }

      .btn-other {
        background-color: #ff9800;
        color: white;
      }

      .btn-other:hover:not(:disabled) {
        background-color: #f57c00;
      }

      .btn-result {
        background-color: #2196f3;
        color: white;
      }

      .btn-result:hover:not(:disabled) {
        background-color: #0b7dda;
      }

      .btn-restart {
        background-color: #764ba2;
        color: white;
      }

      .btn-restart:hover {
        background-color: #5a3680;
      }

      .results {
        text-align: center;
        padding: 20px;
      }

      .results h2 {
        font-size: 2rem;
        margin-bottom: 20px;
        color: #667eea;
      }

      .results-details {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin: 30px 0;
      }

      .results-item {
        text-align: center;
        padding: 20px;
        background-color: #f5f5f5;
        border-radius: 10px;
      }

      .results-item p:first-child {
        font-size: 2.5rem;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 10px;
      }

      .comparison-section {
        margin-top: 30px;
        padding: 20px;
        background-color: #f5f5f5;
        border-radius: 10px;
      }

      .comparison-section h3 {
        margin-bottom: 15px;
        color: #667eea;
      }

      .explanation {
        background-color: #f8f9fa;
        border-left: 4px solid #667eea;
        padding: 15px;
        margin-top: 20px;
        margin-bottom: 20px;
        border-radius: 4px;
        display: none;
      }

      .hidden {
        display: none;
      }

      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        font-size: 1.5rem;
      }

      .error {
        text-align: center;
        padding: 40px;
        color: #f44336;
      }

      .setup-screen {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 20px;
        min-height: 100vh;
      }

      .setup-box {
        text-align: center;
        padding: 30px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        max-width: 600px;
      }

      .setup-box h2 {
        color: #667eea;
        margin-bottom: 20px;
      }

      .setup-box input, .setup-box textarea {
        padding: 12px;
        font-size: 1rem;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 10px;
        width: 100%;
      }

      .setup-box button {
        width: 100%;
        margin-top: 10px;
      }

      .other-user-selection {
        padding: 15px;
        background-color: #fff3e0;
        border: 2px solid #ff9800;
        border-radius: 8px;
        margin-top: 15px;
        display: none;
      }

      .other-user-selection.visible {
        display: block;
      }

      .peer-label {
        font-weight: bold;
        color: #ff9800;
        margin-bottom: 10px;
      }

      .copy-btn {
        background-color: #4caf50;
        color: white;
        padding: 8px 12px;
        font-size: 0.9rem;
        margin-left: 10px;
      }

      .copy-btn:hover {
        background-color: #45a049;
      }

      .open-btn {
        background-color: #82aaff;
        color: white;
        padding: 8px 12px;
        font-size: 0.9rem;
        margin-left: 10px;
      }

      .open-btn:hover {
        background-color: #6b95e6;
      }

      @media (max-width: 600px) {
        .results-details {
          grid-template-columns: 1fr;
        }

        .scores {
          flex-direction: column;
          gap: 10px;
        }

        .actions {
          flex-direction: column;
        }

        button {
          width: 100%;
        }

        .setup-box {
          margin: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="loading">Loading quiz application...</div>
    </div>

    <script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js"></script>
    <script>
      function getRoomId() {
        const urlParams = new URLSearchParams(window.location.search);
        let roomId = urlParams.get("room");
        
        if (!roomId) {
          roomId = "quiz-" + Math.random().toString(36).substr(2, 9);
        }
        
        return roomId;
      }

      document.addEventListener("DOMContentLoaded", async function () {
        const urlParams = new URLSearchParams(window.location.search);
        const encodedData = urlParams.get("data");

        if (!encodedData) {
          showSetup();
          return;
        }

        try {
          const base64 = encodedData.replace(/-/g, '+').replace(/_/g, '/').replace(/~/g, '=');
          const binaryString = atob(base64);
          const bytes = new Uint8Array(binaryString.length);
          for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }
          
          const decompressedStream = new Response(
            new Blob([bytes]).stream().pipeThrough(new DecompressionStream('gzip'))
          );
          const decompressed = await decompressedStream.text();
          const quizData = JSON.parse(decompressed);

          if (!Array.isArray(quizData) || quizData.length === 0) {
            showError("Invalid quiz data format. Expected an array of questions.");
            return;
          }

          initMultiplayerQuiz(quizData);
        } catch (error) {
          showError("Failed to load quiz data: " + error.message);
          console.error(error);
        }
      });

      function showSetup() {
        const appElement = document.getElementById("app");
        appElement.innerHTML = `
          <div class="setup-screen">
            <div class="setup-box">
              <h2>Multiplayer Quiz</h2>
              <p style="margin-bottom: 20px; color: #666;">Enter quiz data as JSON array or use sample data</p>
              <textarea id="quizInput" placeholder='[{"question":"What is 2+2?","options":["3","4","5"],"correct_answer":"4","explanation":"2+2 equals 4"}]' style="height:200px; resize:vertical;"></textarea>
              <button class="btn-next" onclick="loadQuiz()">Start Quiz</button>
              <button class="btn-prev" onclick="loadSampleQuiz()" style="margin-top: 10px;">Load Sample Quiz</button>
            </div>
          </div>
        `;
      }

      function unicodeSafeJSONStringify(obj) {
        return JSON.stringify(obj).replace(/[\u007F-\uFFFF]/g, function(ch) {
          return "\\u" + ("0000" + ch.charCodeAt(0).toString(16)).slice(-4);
        });
      }
      
      async function compressAndEncode(data) {
        const jsonString = unicodeSafeJSONStringify(data);
        const stream = new Blob([jsonString]).stream();
        const compressedStream = stream.pipeThrough(new CompressionStream('gzip'));
        const compressedResponse = new Response(compressedStream);
        const compressedBlob = await compressedResponse.blob();
        const compressedBuffer = await compressedBlob.arrayBuffer();
        const compressed = new Uint8Array(compressedBuffer);
        
        let binaryString = '';
        compressed.forEach(byte => {
          binaryString += String.fromCharCode(byte);
        });
        
        const base64 = btoa(binaryString);
        return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '~');
      }

      async function loadQuiz() {
        const input = document.getElementById("quizInput").value;
        try {
          const quizData = JSON.parse(input);
          if (!Array.isArray(quizData)) throw new Error("Must be an array");

          const encoded = await compressAndEncode(quizData);
          window.location.href = window.location.pathname + "?room=" + getRoomId() + "&data=" + encoded;
        } catch (e) {
          alert("Invalid JSON: " + e.message);
        }
      }

      async function loadSampleQuiz() {
        const sampleData = [
          {
            question: "What is the capital of France?",
            options: ["London", "Berlin", "Paris", "Madrid"],
            correct_answer: "Paris",
            explanation: "Paris is the capital and largest city of France."
          },
          {
            question: "Which planet is known as the Red Planet?",
            options: ["Venus", "Mars", "Jupiter", "Saturn"],
            correct_answer: "Mars",
            explanation: "Mars is called the Red Planet because of its reddish appearance due to iron oxide on its surface."
          },
          {
            question: "What is the largest ocean on Earth?",
            options: ["Atlantic Ocean", "Indian Ocean", "Arctic Ocean", "Pacific Ocean"],
            correct_answer: "Pacific Ocean",
            explanation: "The Pacific Ocean is the largest and deepest of the world's five oceanic divisions."
          }
        ];
        const encoded = await compressAndEncode(sampleData);
        window.location.href = window.location.pathname + "?room=" + getRoomId() + "&data=" + encoded;
      }

      function showError(message) {
        const appElement = document.getElementById("app");
        appElement.innerHTML = `
          <div class="container">
            <div class="error">
              <h2>Error</h2>
              <p>${message}</p>
              <button class="btn-next" onclick="location.reload()">Reload</button>
            </div>
          </div>
        `;
      }

      function initMultiplayerQuiz(quizData) {
        const state = {
          currentQuestion: 0,
          totalQuestions: quizData.length,
          correctAnswers: 0,
          peerCorrectAnswers: 0,
          answers: Array(quizData.length).fill(null),
          peerAnswers: Array(quizData.length).fill(null),
          quizCompleted: false,
          peer: null,
          conn: null,
          isInitiator: false,
          showOtherSelection: false,
          roomId: getRoomId(),
          peerId: "quiz-" + Math.random().toString(36).substr(2, 9)
        };

        initP2PConnection(state, quizData);
      }

      function calculatePeerScore(state, quizData) {
        let score = 0;
        for (let i = 0; i < state.totalQuestions; i++) {
          if (state.peerAnswers[i] !== null) {
            const question = quizData[i];
            const correctIndex = question.options.indexOf(question.correct_answer);
            if (Number(state.peerAnswers[i]) === correctIndex) {
              score++;
            }
          }
        }
        // console.log("score", score)
        return score;
      }

      function initP2PConnection(state, quizData) {
        const urlParams = new URLSearchParams(window.location.search);
        const targetPeerId = urlParams.get("peer");
        
        const myPeerId = targetPeerId || state.peerId;
        var peer = new Peer(myPeerId);
        let connectionAttempted = false;

        peer.on("open", (id) => {
          // console.log("Peer opened with ID:", id);
          state.peer = peer;
          state.peerId = id;

          if (targetPeerId && targetPeerId !== id && !connectionAttempted) {
            connectionAttempted = true;
            // console.log("Attempting to connect to peer:", targetPeerId);
            attemptConnection(peer, targetPeerId, state, quizData);
          } else {
            renderLoading(state);
          }
        });

        peer.on("connection", (conn) => {
          // console.log("Incoming connection from:", conn.peer);
          state.conn = conn;
          state.isInitiator = false;
          
          conn.on("open", () => {
            // console.log("Connection established");
            renderQuiz(state, quizData);
          });

          conn.on("data", (data) => {
            try {
              // console.log("Received data:", data);
              const msg = JSON.parse(data);
              state.peerAnswers[msg.question] = msg.answer;
              state.peerCorrectAnswers = calculatePeerScore(state, quizData);
              
              // Update the opponent score display immediately
              const opponentScoreEl = document.querySelector('.score-item:last-child .value');
              if (opponentScoreEl) {
                opponentScoreEl.textContent = state.peerCorrectAnswers;
              }
              
              renderQuiz(state, quizData);
            } catch (e) {
              console.error("Failed to parse peer data:", e);
            }
          });

          conn.on("close", () => {
            // console.log("Connection closed");
            state.conn = null;
            renderQuiz(state, quizData);
          });
          
          conn.on("error", (err) => {
            console.error("Connection error:", err);
            state.conn = null;
            renderQuiz(state, quizData);
          });
        });

        peer.on("error", (err) => {
          console.error("Peer error:", err);
          
          if (err.type === "peer-unavailable" && targetPeerId) {
            console.log("Peer unavailable, becoming host");
            renderLoading(state);
          } else if (err.type === "unavailable-id") {
            console.log("ID taken, reconnecting with new ID");
            const newPeer = new Peer();
            newPeer.on("open", (newId) => {
              state.peer = newPeer;
              state.peerId = newId;
              if (targetPeerId) {
                attemptConnection(newPeer, targetPeerId, state, quizData);
              }
            });
            setupPeerListeners(newPeer, state, quizData);
          } else {
            showError("Connection error: " + err.type);
          }
        });

        document.addEventListener("click", function (e) {
          if (e.target.classList.contains("btn-prev")) {
            navigateToPrevQuestion(state, quizData);
          } else if (e.target.classList.contains("btn-next")) {
            navigateToNextQuestion(state, quizData);
          } else if (e.target.classList.contains("btn-result")) {
            showResults(state, quizData);
          } else if (e.target.classList.contains("btn-restart")) {
            restartQuiz(state, quizData);
          } else if (e.target.classList.contains("btn-other")) {
            toggleOtherUserSelection(state);
          } else if (e.target.classList.contains("copy-btn")) {
            copyToClipboard(e.target.dataset.url);
          } else if (e.target.classList.contains("open-btn")) {
            openToTab(e.target.dataset.url);
          }
        });
      }
      
      function attemptConnection(peer, targetPeerId, state, quizData) {
        // console.log("Connecting to:", targetPeerId);
        const conn = peer.connect(targetPeerId);
        
        conn.on("open", () => {
          // console.log("Connection opened to peer");
          state.conn = conn;
          state.isInitiator = true;
          renderQuiz(state, quizData);
        });
        
        conn.on("data", (data) => {
          try {
            // console.log("attempt connection")
            const msg = JSON.parse(data);
            state.peerAnswers[msg.question] = msg.answer;
            state.peerCorrectAnswers = calculatePeerScore(state, quizData);
            renderQuiz(state, quizData);
          } catch (e) {
            console.error("Failed to parse peer data:", e);
          }
        });
        
        conn.on("close", () => {
          // console.log("Connection closed");
          state.conn = null;
          renderQuiz(state, quizData);
        });
        
        conn.on("error", (err) => {
          console.error("Connection error:", err);
          renderLoading(state);
        });
      }
      
      function setupPeerListeners(peer, state, quizData) {
        peer.on("connection", (conn) => {
          state.conn = conn;
          state.isInitiator = false;
          
          conn.on("open", () => {
            renderQuiz(state, quizData);
          });
          
          conn.on("data", (data) => {
            try {
              // console.log("setup peer listeners")
              const msg = JSON.parse(data);
              state.peerAnswers[msg.question] = msg.answer;
              state.peerCorrectAnswers = calculatePeerScore(state, quizData);
              renderQuiz(state, quizData);
            } catch (e) {
              console.error("Failed to parse peer data:", e);
            }
          });
          
          conn.on("close", () => {
            state.conn = null;
            renderQuiz(state, quizData);
          });
        });
        
        peer.on("error", (err) => {
          console.error("Peer error:", err);
          showError("Connection error: " + err.type);
        });
      }

      function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
          alert("URL copied to clipboard!");
        }).catch(() => {
          alert("Failed to copy URL");
        });
      }

      function openToTab(text) {
        window.open(text, '_blank');
      }

      function renderLoading(state) {
        const appElement = document.getElementById("app");
        const shareUrl = window.location.href.split('?')[0] + "?room=" + state.roomId + "&peer=" + state.peerId +"&data=" + new URLSearchParams(window.location.search).get("data");
        
        appElement.innerHTML = `
          <div class="container">
            <div style="flex-grow: 1; display: flex; align-items: center; justify-content: center;">
              <div style="text-align: center; max-width: 500px;">
                <h2 style="color: #667eea; margin-bottom: 20px;">Waiting for opponent...</h2>
                <p style="margin-bottom: 20px; font-weight: 600;">Room ID: <code style="background: #f5f5f5; padding: 8px 12px; border-radius: 4px;">${state.roomId}</code></p>
                <p style="margin-bottom: 20px; color: #666;">Your Peer ID: <code style="background: #f5f5f5; padding: 8px 12px; border-radius: 4px; font-size: 0.85rem;">${state.peerId}</code></p>
                <p style="margin-bottom: 15px; color: #666; font-size: 0.9rem;">Share this link with another player:</p>
                <button class="copy-btn" data-url="${shareUrl}">Copy Link</button>
                <button class="open-btn" data-url="${shareUrl}">Open Link</button>
                <div style="background: #f5f5f5; padding: 10px; border-radius: 8px; margin-bottom: 15px; word-break: break-all; font-size: 0.85rem;">
                  ${shareUrl}
                </div>
                <p style="margin-top: 20px; color: #999; font-size: 0.85rem;">Connecting using PeerServer...</p>
              </div>
            </div>
          </div>
        `;
      }

      function renderQuiz(state, quizData) {
        const appElement = document.getElementById("app");

        if (state.quizCompleted) {
          renderResults(state, quizData);
          return;
        }

        // Recalculate peer score every time we render
        state.peerCorrectAnswers = calculatePeerScore(state, quizData);

        const question = quizData[state.currentQuestion];
        const isLastQuestion = state.currentQuestion === state.totalQuestions - 1;
        const userAnswer = state.answers[state.currentQuestion];
        const peerAnswer = state.peerAnswers[state.currentQuestion];
        const showFeedback = userAnswer !== null;
        const bothAnswered = userAnswer !== null && (peerAnswer !== null || !state.conn);

        let optionsHtml = "";

        question.options.forEach((option, index) => {
          const isSelected = userAnswer === index;
          const isCorrect = showFeedback && index === question.options.indexOf(question.correct_answer);
          const isIncorrect = showFeedback && isSelected && !isCorrect;
          const isPeerSelected = peerAnswer !== null && index === peerAnswer && state.showOtherSelection;

          let optionClass = "option";
          if (isSelected) optionClass += " selected";
          if (showFeedback && isCorrect) optionClass += " correct";
          if (isIncorrect) optionClass += " incorrect";
          if (isPeerSelected && !isSelected) optionClass += " other-user-selected";

          optionsHtml += `
            <div class="${optionClass}" data-index="${index}">
              <input type="radio" name="option" id="option${index}" ${isSelected ? "checked" : ""} ${showFeedback ? "disabled" : ""}>
              <label for="option${index}">
                <span class="radio"></span>
                ${option}
                <span class="mark">${isCorrect ? "✓" : isIncorrect ? "✘" : ""}</span>
                ${isPeerSelected ? '<span class="option-indicator">Other Player</span>' : ''}
              </label>
            </div>
          `;
        });

        const progress = ((state.currentQuestion + 1) / state.totalQuestions) * 100;
        const connectionStatus = state.conn ? "Connected" : "Waiting for opponent...";
        const statusClass = state.conn ? "status-connected" : "status-waiting";
        
        const opponentScoreDisplay = state.conn ? state.peerCorrectAnswers : "–";

        let waitingMessage = "";
        if (userAnswer !== null && peerAnswer === null && state.conn) {
          waitingMessage = `
            <div style="background-color: #fff3e0; padding: 15px; border-radius: 8px; margin-top: 15px; text-align: center;">
              <span style="color: #e65100; font-weight: 500;">⏳ Waiting for opponent to answer...</span>
            </div>
          `;
        }

        let otherUserHtml = "";
        if (peerAnswer !== null && userAnswer !== null) {
          const peerOption = quizData[state.currentQuestion].options[peerAnswer];
          otherUserHtml = `
            <div class="other-user-selection ${state.showOtherSelection ? 'visible' : ''}">
              <div class="peer-label">📱 Other Player Selected:</div>
              <div style="font-size: 1.1rem; padding: 10px; background: white; border-radius: 6px;">${peerOption}</div>
            </div>
          `;
        }

        appElement.innerHTML = `
          <div class="container">
            <div class="connection-status">
              <span class="status-badge status-room-id">Room: ${state.roomId}</span>
              <span class="status-badge ${statusClass}">${connectionStatus}</span>
            </div>

            <div class="progress-bar">
              <div class="progress" style="width: ${progress}%"></div>
            </div>

            <div class="header">
              <div style="font-size: 1.1rem; font-weight: 600;">Question ${state.currentQuestion + 1} of ${state.totalQuestions}</div>
              <div class="scores">
                <div class="score-item">
                  <div class="label">Your Score</div>
                  <div class="value">${state.correctAnswers}</div>
                </div>
                <div class="score-item">
                  <div class="label">Opponent</div>
                  <div class="value">${opponentScoreDisplay}</div>
                </div>
              </div>
            </div>

            <div class="quiz-container">
              <div class="question">${question.question}</div>
              <div class="options">${optionsHtml}</div>

              <div class="explanation" ${showFeedback ? 'style="display:block"' : ""}>
                <p>${question.explanation}</p>
              </div>

              ${waitingMessage}
              ${otherUserHtml}
            </div>

            <div class="actions">
              <button class="btn-prev" ${state.currentQuestion === 0 ? "disabled" : ""}>← Previous</button>
              ${peerAnswer !== null && userAnswer !== null && !state.showOtherSelection ? 
                `<button class="btn-other">👀 See Opponent</button>` : 
                ''}
              ${isLastQuestion ?
                `<button class="btn-result" ${!bothAnswered ? "disabled" : ""}>See Results →</button>` :
                `<button class="btn-next" ${!bothAnswered ? "disabled" : ""}>Next →</button>`
              }
            </div>
          </div>
        `;

        if (!showFeedback) {
          document.querySelectorAll(".option").forEach((option) => {
            option.addEventListener("click", function () {
              selectOption(this.dataset.index, state, quizData);
            });
          });
        }
      }

      function selectOption(optionIndex, state, quizData) {
        const question = quizData[state.currentQuestion];
        const selectedOption = question.options[optionIndex];
        const isCorrect = selectedOption === question.correct_answer;

        state.answers[state.currentQuestion] = parseInt(optionIndex);

        if (isCorrect) {
          state.correctAnswers++;
        }

        if (state.conn) {
          state.conn.send(JSON.stringify({
            question: state.currentQuestion,
            answer: optionIndex
          }));
        }

        state.showOtherSelection = false;
        renderQuiz(state, quizData);
      }

      function toggleOtherUserSelection(state) {
        state.showOtherSelection = !state.showOtherSelection;
        const otherDiv = document.querySelector(".other-user-selection");
        if (otherDiv) {
          otherDiv.classList.toggle("visible");
        }
      }

      function navigateToPrevQuestion(state, quizData) {
        if (state.currentQuestion > 0) {
          state.currentQuestion--;
          state.showOtherSelection = false;
          renderQuiz(state, quizData);
        }
      }

      function navigateToNextQuestion(state, quizData) {
        if (state.currentQuestion < state.totalQuestions - 1) {
          state.currentQuestion++;
          state.showOtherSelection = false;
          renderQuiz(state, quizData);
        }
      }

      function showResults(state, quizData) {
        state.quizCompleted = true;
        renderQuiz(state, quizData);
      }

      function renderResults(state, quizData) {
        const appElement = document.getElementById("app");
        const percentage = Math.round((state.correctAnswers / state.totalQuestions) * 100);
        const incorrectAnswers = state.totalQuestions - state.correctAnswers;

        let peerCorrectAnswers = state.peerCorrectAnswers;
        const peerPercentage = state.conn ? Math.round((peerCorrectAnswers / state.totalQuestions) * 100) : 0;
        const peerIncorrect = state.totalQuestions - peerCorrectAnswers;

        let winnerText = "";
        if (state.conn) {
          if (state.correctAnswers > peerCorrectAnswers) {
            winnerText = '<div style="font-size: 1.5rem; color: #4caf50; font-weight: bold; margin-bottom: 20px;">🏆 You Win!</div>';
          } else if (state.correctAnswers < peerCorrectAnswers) {
            winnerText = '<div style="font-size: 1.5rem; color: #ff9800; font-weight: bold; margin-bottom: 20px;">😊 Opponent Wins!</div>';
          } else {
            winnerText = '<div style="font-size: 1.5rem; color: #667eea; font-weight: bold; margin-bottom: 20px;">🤝 It\'s a Tie!</div>';
          }
        }

        const multiplayerResults = state.conn ? `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 30px 0;">
            <div style="padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; color: white;">
              <h3 style="margin-bottom: 15px; font-size: 1.3rem;">👤 Your Results</h3>
              <div style="font-size: 3rem; font-weight: bold; margin: 15px 0;">${percentage}%</div>
              <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 8px;">
                  <span>Correct:</span>
                  <span style="font-weight: bold;">${state.correctAnswers}/${state.totalQuestions}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 8px;">
                  <span>Wrong:</span>
                  <span style="font-weight: bold;">${incorrectAnswers}</span>
                </div>
              </div>
            </div>

            <div style="padding: 20px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 15px; color: white;">
              <h3 style="margin-bottom: 15px; font-size: 1.3rem;">🎮 Opponent Results</h3>
              <div style="font-size: 3rem; font-weight: bold; margin: 15px 0;">${peerPercentage}%</div>
              <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 8px;">
                  <span>Correct:</span>
                  <span style="font-weight: bold;">${peerCorrectAnswers}/${state.totalQuestions}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 8px;">
                  <span>Wrong:</span>
                  <span style="font-weight: bold;">${peerIncorrect}</span>
                </div>
              </div>
            </div>
          </div>
        ` : `
          <div style="font-size: 4rem; font-weight: bold; color: #667eea; margin: 20px 0;">
            ${percentage}%
          </div>

          <div class="results-details">
            <div class="results-item">
              <p>${state.totalQuestions}</p>
              <p>Total Questions</p>
            </div>
            <div class="results-item">
              <p style="color: #4caf50;">${state.correctAnswers}</p>
              <p>Correct</p>
            </div>
            <div class="results-item">
              <p style="color: #f44336;">${incorrectAnswers}</p>
              <p>Wrong</p>
            </div>
          </div>
        `;

        appElement.innerHTML = `
          <div class="container">
            <div class="results">
              <h2>Quiz Complete! 🎉</h2>
              ${winnerText}
              ${multiplayerResults}
              <button class="btn-restart">Try Again</button>
            </div>
          </div>
        `;       
      }

      function restartQuiz(state, quizData) {
        state.currentQuestion = 0;
        state.correctAnswers = 0;
        state.peerCorrectAnswers = 0;
        state.answers = Array(state.totalQuestions).fill(null);
        state.peerAnswers = Array(state.totalQuestions).fill(null);
        state.quizCompleted = false;
        state.showOtherSelection = false;

        renderQuiz(state, quizData);
      }
    </script>
  </body>
</html>
