<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PeerJS WebRTC Test</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.3/peerjs.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .card h2 {
      color: #667eea;
      margin-bottom: 15px;
      font-size: 1.5rem;
    }

    .input-group {
      margin-bottom: 15px;
    }

    .input-group label {
      display: block;
      margin-bottom: 5px;
      color: #555;
      font-weight: 500;
    }

    .input-group input {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .input-group input:focus {
      outline: none;
      border-color: #667eea;
    }

    button {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .status {
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 15px;
      font-weight: 500;
    }

    .status.disconnected {
      background: #fee;
      color: #c33;
      border: 1px solid #fcc;
    }

    .status.connected {
      background: #efe;
      color: #3c3;
      border: 1px solid #cfc;
    }

    .status.connecting {
      background: #ffeaa7;
      color: #d63031;
      border: 1px solid #fdcb6e;
    }

    .log {
      background: #f5f5f5;
      border-radius: 6px;
      padding: 15px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      margin-top: 15px;
    }

    .log-entry {
      padding: 5px 0;
      border-bottom: 1px solid #e0e0e0;
    }

    .log-entry:last-child {
      border-bottom: none;
    }

    .log-entry.info { color: #667eea; }
    .log-entry.success { color: #00b894; }
    .log-entry.error { color: #d63031; }

    .messages {
      background: #f5f5f5;
      border-radius: 6px;
      padding: 15px;
      min-height: 200px;
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 15px;
    }

    .message {
      padding: 8px 12px;
      margin-bottom: 8px;
      border-radius: 6px;
      word-wrap: break-word;
    }

    .message.sent {
      background: #667eea;
      color: white;
      margin-left: 20%;
      text-align: right;
    }

    .message.received {
      background: white;
      color: #333;
      margin-right: 20%;
    }

    .info-box {
      background: #e3f2fd;
      border-left: 4px solid #667eea;
      padding: 12px;
      margin-bottom: 15px;
      border-radius: 4px;
      font-size: 14px;
    }

    .info-box code {
      background: white;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üåê PeerJS WebRTC Test</h1>
      <p>Test your PeerJS signaling server</p>
    </div>

    <div class="cards">
      <div class="card">
        <h2>üì° Connection Setup</h2>
        <div class="input-group">
          <label for="serverHost">Server Host:</label>
          <input type="text" id="serverHost" value="mindtools.vercel.app" placeholder="localhost or your-app.vercel.app">
        </div>
        <div class="input-group">
          <label for="serverPort">Server Port:</label>
          <input type="number" id="serverPort" value="3000" placeholder="3000 (leave empty for production)">
        </div>
        <div class="input-group">
          <label for="peerId">Your Peer ID:</label>
          <input type="text" id="peerId" placeholder="Leave empty for random ID">
        </div>
        <button id="connectBtn" onclick="initPeer()">Connect to Server</button>
        <div id="status" class="status disconnected">Disconnected</div>
        <div class="info-box">
          <strong>Your Peer ID:</strong> <code id="myPeerId">Not connected</code>
        </div>
      </div>

      <div class="card">
        <h2>üí¨ Messaging</h2>
        <div class="input-group">
          <label for="remotePeerId">Remote Peer ID:</label>
          <input type="text" id="remotePeerId" placeholder="Enter peer ID to connect">
        </div>
        <button id="callBtn" onclick="connectToPeer()" disabled>Connect to Peer</button>
        <div class="messages" id="messages"></div>
        <div class="input-group">
          <input type="text" id="messageInput" placeholder="Type a message..." disabled>
        </div>
        <button id="sendBtn" onclick="sendMessage()" disabled>Send Message</button>
      </div>
    </div>

    <div class="card">
      <h2>üìã Connection Log</h2>
      <div class="log" id="log"></div>
    </div>
  </div>

  <script>
    let peer = null;
    let conn = null;

    function log(message, type = 'info') {
      const logEl = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      const time = new Date().toLocaleTimeString();
      entry.textContent = `[${time}] ${message}`;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function updateStatus(status, type) {
      const statusEl = document.getElementById('status');
      statusEl.textContent = status;
      statusEl.className = `status ${type}`;
    }

    function addMessage(text, isSent) {
      const messagesEl = document.getElementById('messages');
      const msg = document.createElement('div');
      msg.className = `message ${isSent ? 'sent' : 'received'}`;
      msg.textContent = text;
      messagesEl.appendChild(msg);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function initPeer() {
      if (peer) {
        log('Closing existing connection...', 'info');
        peer.destroy();
      }

      const host = document.getElementById('serverHost').value;
      const port = document.getElementById('serverPort').value;
      const peerId = document.getElementById('peerId').value || undefined;

      log('Initializing peer connection...', 'info');
      updateStatus('Connecting...', 'connecting');

      const config = {
        host: host,
        path: '/api',
        debug: 2
      };

      // Add port only for localhost
      if (host === 'localhost' || host === '127.0.0.1') {
        config.port = parseInt(port) || 3000;
      } else {
        config.secure = true;
      }

      peer = new Peer(peerId, config);

      peer.on('open', (id) => {
        log(`Connected! Your ID: ${id}`, 'success');
        document.getElementById('myPeerId').textContent = id;
        updateStatus('Connected', 'connected');
        document.getElementById('callBtn').disabled = false;
        document.getElementById('connectBtn').textContent = 'Reconnect';
      });

      peer.on('connection', (connection) => {
        log(`Incoming connection from: ${connection.peer}`, 'info');
        setupConnection(connection);
      });

      peer.on('error', (err) => {
        log(`Error: ${err.type} - ${err.message}`, 'error');
        updateStatus('Error - Check console', 'disconnected');
      });

      peer.on('disconnected', () => {
        log('Disconnected from server', 'error');
        updateStatus('Disconnected', 'disconnected');
      });

      peer.on('close', () => {
        log('Connection closed', 'info');
        updateStatus('Closed', 'disconnected');
      });
    }

    function connectToPeer() {
      const remotePeerId = document.getElementById('remotePeerId').value;
      
      if (!remotePeerId) {
        alert('Please enter a remote peer ID');
        return;
      }

      if (!peer) {
        alert('Please connect to server first');
        return;
      }

      log(`Connecting to peer: ${remotePeerId}`, 'info');
      conn = peer.connect(remotePeerId);
      setupConnection(conn);
    }

    function setupConnection(connection) {
      conn = connection;

      conn.on('open', () => {
        log(`Data connection established with: ${conn.peer}`, 'success');
        document.getElementById('messageInput').disabled = false;
        document.getElementById('sendBtn').disabled = false;
        addMessage('Connected! You can now send messages.', false);
      });

      conn.on('data', (data) => {
        log(`Received: ${data}`, 'info');
        addMessage(data, false);
      });

      conn.on('close', () => {
        log('Data connection closed', 'info');
        document.getElementById('messageInput').disabled = true;
        document.getElementById('sendBtn').disabled = true;
      });

      conn.on('error', (err) => {
        log(`Connection error: ${err}`, 'error');
      });
    }

    function sendMessage() {
      const input = document.getElementById('messageInput');
      const message = input.value.trim();

      if (!message) return;

      if (!conn || !conn.open) {
        alert('No active connection');
        return;
      }

      conn.send(message);
      log(`Sent: ${message}`, 'success');
      addMessage(message, true);
      input.value = '';
    }

    // Send message on Enter key
    document.getElementById('messageInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });
  </script>
</body>
</html>
